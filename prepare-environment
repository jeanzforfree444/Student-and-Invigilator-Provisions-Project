#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$SCRIPT_DIR"
COMPOSE_ENV_FILE="$REPO_ROOT/ops/compose/.env"

HOST_UID="${HOST_UID_OVERRIDE:-$(id -u)}"
HOST_GID="${HOST_GID_OVERRIDE:-$(id -g)}"

mkdir -p "$(dirname "$COMPOSE_ENV_FILE")"
mkdir -p "$REPO_ROOT/.docker/node_modules/frontend"

cat > "$COMPOSE_ENV_FILE" <<EOF
HOST_UID=$HOST_UID
HOST_GID=$HOST_GID
EOF

echo "Written Docker Compose UID/GID overrides to ops/compose/.env"

exec "$REPO_ROOT/refresh-environment" "$@"
